name: "Run TT-Metal Tests"

on:
  workflow_dispatch:
    inputs:
      build_image:
        description: 'Docker image for build job'
        required: false
        default: 'ghcr.io/tenstorrent/tt-metal/tt-metalium/ubuntu-22.04-ci-build-amd64:latest'
        type: string
      dev_image:
        description: 'Docker image for test jobs'
        required: false
        default: 'ghcr.io/tenstorrent/tt-metal/tt-metalium/ubuntu-22.04-dev-amd64:latest'
        type: string
      manylinux_image:
        description: 'Docker image for Python wheel building'
        required: false
        default: 'ghcr.io/tenstorrent/tt-metal/tt-metalium/manylinux-amd64:latest'
        type: string
      test_command:
        description: 'Test command to run (e.g., "pytest --timeout 300 tests/ttnn/unit_tests/operations/matmul -xv" for TTNN or "ctest -E NIGHTLY --no-tests=error --output-on-failure" for tt-train)'
        required: false
        default: 'pytest --timeout 300 tests/ttnn/unit_tests/operations/matmul -xv -m "not disable_fast_runtime_mode"'
        type: string
      reference:
        description: 'Branch name, tag, or commit hash to checkout (default: main)'
        required: false
        default: 'main'
        type: string

jobs:
  build-artifact:
    name: "ðŸ› ï¸ Build Release ubuntu 22.04"
    timeout-minutes: 100
    runs-on: tt-ubuntu-2204-large-stable
    environment: ${{ github.ref == 'refs/heads/main' && 'mainline' || '' }}
    outputs:
      build_artifact_name: ${{ steps.set_build_artifact_name.outputs.build_artifact_name }}
    container:
      image: ${{ inputs.build_image }}
      env:
        CCACHE_REMOTE_ONLY: "true"
        CCACHE_TEMPDIR: /tmp/ccache
        TRACY_NO_INVARIANT_CHECK: 1
        TRACY_NO_ISA_EXTENSIONS: 1
      volumes:
        - ${{ github.workspace }}/docker-job:/work
        - /home/ubuntu/.ccache-ci:/github/home/.ccache
      options: >
        --group-add 1457
        --tmpfs /tmp
    defaults:
      run:
        shell: bash
        working-directory: /work
    steps:
      - name: Check Redis credentials
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          if [ -z "${{ secrets.REDIS_PASSWORD }}" ]; then
            echo "Redis password is missing. Did you forget 'secrets: inherit'?"
            exit 1
          fi
          CCACHE_REMOTE_STORAGE="redis://${{ vars.REDIS_USER }}:${{ secrets.REDIS_PASSWORD }}@${{ vars.REDIS_HOST }}:${{ vars.REDIS_PORT }}|read-only=${{ vars.REDIS_IS_READONLY }}"
          echo "CCACHE_REMOTE_STORAGE=${CCACHE_REMOTE_STORAGE}" >> $GITHUB_ENV

      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4
        with:
          repository: 'tenstorrent/tt-metal'
          ref: ${{ inputs.reference || github.ref }}
          submodules: recursive
          fetch-depth: 500
          fetch-tags: true
          path: docker-job

      - name: Create ccache tmpdir
        run: mkdir -p /tmp/ccache

      - name: Prepare ccache
        run: ccache -z

      - name: ðŸ”§ CMake configure
        run: |
          ./build_metal.sh --build-dir build --build-type Release --toolchain-path cmake/x86_64-linux-clang-20-libstdcpp-toolchain.cmake --build-metal-tests --build-ttnn-tests --build-programming-examples --build-tt-train --enable-ccache --configure-only

      - name: ðŸ› ï¸ Compile
        run: cmake --build build --target install

      - name: ðŸ“¦ Package
        run: cmake --build build --target package

      - name: Publish ccache summary
        run: |
          echo '## Build CCache Summary' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ccache -s >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: 'Tar build files'
        run: |
          ARTIFACT_PATHS="ttnn/ttnn/*.so build/lib build/programming_examples build/test build/tools build/tt-train runtime data"
          tar -I 'zstd --adapt=min=9 -T0' -cvhf ttm_any.tar.zst $ARTIFACT_PATHS

      - name: Set build artifact name
        id: set_build_artifact_name
        run: |
          ARTIFACT_NAME="ttm-build-any-Release-${{ github.sha }}-${{ github.run_id }}"
          echo "build_artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT

      - name: â˜ï¸ Upload build tarball
        uses: actions/upload-artifact@v4
        timeout-minutes: 10
        with:
          name: ${{ steps.set_build_artifact_name.outputs.build_artifact_name }}
          path: /work/ttm_any.tar.zst
          if-no-files-found: error
          retention-days: 1

  build-wheel:
    name: "ðŸ Build Python Wheel"
    timeout-minutes: 30
    runs-on: tt-ubuntu-2204-large-stable
    environment: ${{ github.ref == 'refs/heads/main' && 'mainline' || '' }}
    outputs:
      wheel_artifact_name: ${{ steps.set_wheel_artifact_name.outputs.wheel_artifact_name }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Check Redis credentials
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          if [ -z "${{ secrets.REDIS_PASSWORD }}" ]; then
            echo "Redis password is missing. Did you forget 'secrets: inherit'?"
            exit 1
          fi
          CCACHE_REMOTE_STORAGE="redis://${{ vars.REDIS_USER }}:${{ secrets.REDIS_PASSWORD }}@${{ vars.REDIS_HOST }}:${{ vars.REDIS_PORT }}|read-only=${{ vars.REDIS_IS_READONLY }}"
          echo "CCACHE_REMOTE_STORAGE=${CCACHE_REMOTE_STORAGE}" >> $GITHUB_ENV
          echo "CCACHE_REMOTE_STORAGE: ${CCACHE_REMOTE_STORAGE}"

      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4
        with:
          repository: 'tenstorrent/tt-metal'
          ref: ${{ inputs.reference || github.ref }}
          submodules: recursive
          fetch-depth: 500
          fetch-tags: true

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: ðŸ Build wheel
        uses: pypa/cibuildwheel@v2.23.2
        env:
          CIBW_BUILD: "cp310-manylinux_x86_64*"
          CIBW_SKIP: "*-musllinux_*"
          CIBW_BUILD_FRONTEND: build
          CIBW_ENVIRONMENT: >-
            CCACHE_REMOTE_ONLY=true
            CCACHE_TEMPDIR=/tmp/ccache
            CCACHE_REMOTE_STORAGE="${{ env.CCACHE_REMOTE_STORAGE }}"
            CIBW_ENABLE_TRACY=ON
            CIBW_BUILD_TYPE=Release
          CIBW_BEFORE_BUILD: "mkdir -p /tmp/ccache && ccache -z && ccache -p"
          CIBW_BEFORE_TEST: ccache -s
          CIBW_TEST_COMMAND: 'python -c "import ttnn"'
          CIBW_MANYLINUX_X86_64_IMAGE: ${{ inputs.manylinux_image }}

      - name: Set wheel artifact name
        id: set_wheel_artifact_name
        run: |
          ARTIFACT_NAME="ttnn-dist-cp310-Release-${{ github.sha }}-${{ github.run_id }}"
          echo "wheel_artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT

      - name: â˜ï¸ Upload wheel
        uses: actions/upload-artifact@v4
        timeout-minutes: 10
        with:
          name: ${{ steps.set_wheel_artifact_name.outputs.wheel_artifact_name }}
          path: wheelhouse
          if-no-files-found: error
          retention-days: 1

  tt-metal-test:
    needs: [build-wheel, build-artifact]
    name: TT-Metal Tests
    runs-on: tt-ubuntu-2204-N300-stable
    environment: ${{ github.ref == 'refs/heads/main' && 'mainline' || '' }}
    container:
      image: ${{ inputs.dev_image }}
      env:
        TT_METAL_HOME: /work
        TT_METAL_RUNTIME_ROOT: /work
        LD_LIBRARY_PATH: /work/build/lib
        PYTHONPATH: /work
        ARCH_NAME: wormhole_b0
        CCACHE_TEMPDIR: /tmp/ccache
        CCACHE_DEBUG: 1
        CCACHE_DEBUGDIR: /tmp/ccache-debug
        CCACHE_COMPILERCHECK: content
        TT_METAL_CCACHE_KERNEL_SUPPORT: 1
        TT_METAL_LOGGER_LEVEL: Debug
        TT_METAL_LOGGER_TYPES: BuildKernels
        TT_METAL_LOG_KERNELS_COMPILE_COMMANDS: 1
      volumes:
        - ${{ github.workspace }}/docker-job:/work
        - /dev/hugepages-1G:/dev/hugepages-1G
        - /home/ubuntu/.ccache-ci:/github/home/.ccache
      options: "--device /dev/tenstorrent"
    defaults:
      run:
        shell: bash
        working-directory: /work
    steps:
      - name: Check Redis credentials
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          if [ -z "${{ secrets.REDIS_CCACHE_PASSWORD }}" ]; then
            echo "Redis ccache password is missing. Did you forget 'secrets: inherit'?"
            exit 1
          fi
          CCACHE_REMOTE_STORAGE="redis://${{ vars.REDIS_CCACHE_USER }}:${{ secrets.REDIS_CCACHE_PASSWORD }}@${{ vars.REDIS_CCACHE_HOST }}:${{ vars.REDIS_CCACHE_PORT }}|read-only=${{ vars.REDIS_CCACHE_IS_READONLY }}"
          echo "CCACHE_REMOTE_STORAGE=${CCACHE_REMOTE_STORAGE}" >> $GITHUB_ENV

      - name: Create ccache tmpdir
        run: mkdir -p /tmp/ccache

      - name: Pre-create ccache files for ephemeral runner
        run: |
          echo "=== Creating ccache files for ephemeral runner ==="
          # Create inode cache file that ccache expects
          touch /tmp/ccache/inode-cache-64.v2
          # Set appropriate permissions
          chmod 644 /tmp/ccache/inode-cache-64.v2
          echo "Created inode cache file:"
          ls -la /tmp/ccache/inode-cache-64.v2
          echo "ccache temp directory structure:"
          ls -la /tmp/ccache/
          # Create debug directory
          mkdir -p /tmp/ccache-debug

      - name: ðŸ§¬ Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: 'tenstorrent/tt-metal'
          ref: ${{ inputs.reference || github.ref }}
          submodules: recursive
          path: docker-job

      - name: ðŸ“¦ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-artifact.outputs.build_artifact_name }}
          path: docker-job

      - name: ðŸ“‚ Extract Build Files
        working-directory: docker-job
        run: tar --zstd -xf ttm_any.tar.zst

      - name: ðŸ§ª Download Python Wheel
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-wheel.outputs.wheel_artifact_name }}
          path: docker-job

      - name: ðŸ’¿ Install Wheel
        working-directory: docker-job
        run: |
          WHEEL_FILENAME=$(ls -1 *.whl)
          echo "ðŸ“¦ Installing $WHEEL_FILENAME"
          uv pip install "$WHEEL_FILENAME"

      - name: Install test dependencies
        run: |
          uv pip install pytest pytest-timeout

      - name: Test Redis connection
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          REDIS_HOST="${{ vars.REDIS_CCACHE_HOST }}"
          REDIS_PORT="${{ vars.REDIS_CCACHE_PORT }}"
          REDIS_USER="${{ vars.REDIS_CCACHE_USER }}"
          REDIS_PASS="${{ secrets.REDIS_CCACHE_PASSWORD }}"
          if ! command -v redis-cli >/dev/null 2>&1; then
            echo "Installing redis-cli..."
            apt-get update -qq && apt-get install -y -qq redis-tools
          fi
          echo "Testing Redis connectivity at $REDIS_HOST:$REDIS_PORT (user: $REDIS_USER)"
          if ! redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" --user "$REDIS_USER" -a "$REDIS_PASS" --no-auth-warning PING; then
            echo "Redis PING failed. Running diagnostics..."
            redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" --user "$REDIS_USER" -a "$REDIS_PASS" --no-auth-warning INFO server || true
            redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" --user "$REDIS_USER" -a "$REDIS_PASS" --no-auth-warning INFO clients || true
            redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" --user "$REDIS_USER" -a "$REDIS_PASS" --no-auth-warning CONFIG GET requirepass || true
            exit 1
          fi

      - name: Run tests
        timeout-minutes: 30
        run: |
          echo "Running tests..."
          ${{ inputs.test_command }}

      - name: Publish ccache summary
        run: |
          echo '## Test CCache Summary' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ccache -s >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo '## CCache Debug - Key Calculation' >> $GITHUB_STEP_SUMMARY
          echo 'Debug files in /tmp/ccache-debug:' >> $GITHUB_STEP_SUMMARY
          if [ -d /tmp/ccache-debug ] && [ "$(ls -A /tmp/ccache-debug 2>/dev/null)" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            # Show first few debug log files with key calculation info
            for f in $(find /tmp/ccache-debug -name '*.ccache-log' 2>/dev/null | head -5); do
              echo "=== $f ===" >> $GITHUB_STEP_SUMMARY
              cat "$f" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            done
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            echo '### Cache hit/miss decisions - first 20' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -rE "(cache hit|cache miss|No such file|Storing embedded entry)" /tmp/ccache-debug/ | head -20 >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo 'No debug files found' >> $GITHUB_STEP_SUMMARY
          fi